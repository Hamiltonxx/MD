## 智能图像服务性能测试
- 单张3090能承受多少用户同时使用一个功能，又能承受多少用户同时使用多少个功能？这是一个Nx1到Nx7的问题(对于现在的7个功能),尤其对于视频的并发处理、视频与图片的混合并发处理。我们针对上线的功能，进行一下性能测试，目的是探究单卡支持智能图像服务的性能究竟如何。
    - 测试方法：
        - 直接在开发者平台上上传图片、视频，并实时监控GPU显存占用率和后端视频处理进程。对单个模块同时上传20个视频进行了压力测试；对所有模块同时上传多个视频进行了压力测试；针对所有模块同时上传图片和视频进行了压力测试。
        - 用户上传的图片会直接在内存里等待处理，而用户上传的视频会从oss服务器下载到~/projects/gpuservice/video_download/文件夹下，处理后的视频会暂时放在~/projects/gpuservice/video_upload/文件夹下，待整个视频处理完成后，再统一上传到oss服务器中。因此，我们在进行测试的时候，要看两个文件夹中文件的个数，以此来判断排队处理的情况；另外要监控gpu的显存占用率和使用率，防止出现显存占用率过高和显存性能被吃满的情况发生。
        - 我们的测试界面是这样的，初始状态下显存占用率5G，video_download和video_upload内没有文件。我们同时上传18个不重名的视频，看后端视频文件数量和显存使用率。



        <img src='https://pro-developer.oss-cn-shanghai.aliyuncs.com/74/img/1663318020848_66c49630b90bfa4ae0be16344bc9498.jpg' width="700" align=center/>

    - 测试结果：
        - 理论上用户可以不加限制地上传图片和视频，但后台能够同时处理的图片和视频的总量为6到7个，多余的任务会自动排队，待后台队列任务完成后自动补位。这个排队阻塞机制，应该是flask框架的问题，判断理由有两个————
            - 本地只同时存在6-7个视频在处理中
            - 在new_detection.py中在video_download_process_upload函数之前打印了"args ready begin job"字符串，在日志中，这个字符串的出现时机是在某个视频处理并上传完成后，还没有到模型处理部分，单纯是还没有开始从oss向后端下载。
        - 同时处理6个任务的GPU使用率峰值在40%，基本维持在30%~40%之间，持续运行无压力，无显存泄露或者爆显存的风险。另外在框架中已经添加了监控显存占用率，强制用户在显存占用率过高的情况下进行排队的机制，因此无特殊情况，可以保证服务安全。个人建议现在的视频并发是合理的，不会占用太多显存和计算资源，而且只要视频不重名，后台处理就只会阻塞而不会死锁，能够正常处理并返回视频。
        - 测试视频如下：

        <video controls src="https://pro-developer.oss-cn-shanghai.aliyuncs.com/video/%E6%B5%8B%E8%AF%95.mp4"> </video>
        

- 发版前仍需解决的问题：用户上传视频但后端处理的途中刷新界面后，后端停止处理上传的视频以释放资源。 
