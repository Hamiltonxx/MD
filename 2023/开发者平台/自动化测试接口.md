# 说明
由于部分接口会分散在各个技术文档中，为了统一跑自动化测试流程，我们再重新收集一下接口。可能没有包含全部接口，但需要测试的主要功能接口都会在这里。后面也可能会新增接口。  
为了确保可用性，测试服和正式服每天至少都要测一遍。  
测试服的地址: https://beta-dev.yijinar.com   
正式服地址: https://dev.yijianar.com
# 接口列表
这里列出所有可能需要自动化测试的接口，只给出简单接口说明和参数说明。具体的解释说明可在相关的技术板块的文档里找。
```shell
/ping
/wxlogin
/query_user
/ddcallback
/wxcallback
/md_upload
/mkdir
/rmdir
/rmfile
/rnfile
/mvdir
/mvfile
/lsdir
/rndir
/publish_files
/search_title_in_apifolder
/search_tag_in_apifolder
/search_content_in_apifolder
/search_all_in_apifolder
/refresh_permission
/get_phonecode
/bind_wx_phone
/set_dd_password
/register_phone
/phonelogin
/phonecodelogin
/get_emailcode
/register_email
/emaillogin
/reset_password
/bind_email
/bind_phone
/bind_wechat
/bind_dingtalk
/unbind_wechat
/unbind_dingtalk
/check_phone_code
/change_phone
/check_email_code
/change_email
/emailcodelogin
/reset_email_password
/sync_dd_dept
/uploadfile
/get_oss_signature
/osscallback
/list_files
/get_download_url
/list_users
/edit_user
/list_groups
/new_group
/edit_group
/delete_group
/list_group_users
/add_group_user
/delete_group_user
/mserver_callback/{taskid}
/query_tasks
/start_task
/restart_task
/cancel_task
/query_mserver_task
/query_task_duration
/download_url_model
/autodesk_token
/bimface_viewtoken
/receive_box_data
/gpsconsume
/gpsquery
/upload_gps_txt
/rtkbox_list
/rtkbox_shutdown
/rtkbox_reboot
```

# Authorization
token认证信息请包含在请求header里。形式为 curl -H 'Authorization:Bearer TOKEN'  
以下这些情形，接口不需要token认证  
1. 非开发者平台接口  
2. 注册登录及获取验证码  
3. 上传的数据里已包含了身份信息  
此列表也会视安全规则作增减和修改。
```shell
/ping
/ddcallback
/wxcallback
/wxlogin
/get_phonecode
/bind_wx_phone
/register_phone
/phonelogin
/phonecodelogin
/get_emailcode
/register_email
/emaillogin
/check_phone_code
/check_email_code
/emailcodelogin
/get_oss_signature
/osscallback
/get_download_url
/mserver_callback/{taskid}
/query_mserver_task
/query_task_duration
/autodesk_token
/bimface_viewtoken
/receive_box_data
```
其他接口需要在注册登录相关接口里，拿到token.   
token有效时间为24小时。若再次调用接口，则有效时间更新24小时。

# 释义和示例
以下$HOST用 https://dev.yijianar.com/api 或 https://beta-dev.yijinar.com/api 替代  
OSS直传，模型处理等查看结果的回调接口暂不列出
## ping
快速检测服务是否在线
```
curl $HOST/ping
```
------
## wxlogin
已注册的微信登录,注意微信注册登录接口目前只能在正式服测，因为回调地址只能设一个。
```
curl -X POST -d '{"code":"001gFT0w34zkHZ2xtJ2w3ybNGn2gFT0f"}' $HOST/wxlogin
```
## bind_wx_phone
未注册的微信，调用wxlogin后。会让绑定手机号。这里和bind_phone的区别是会把微信信息强制加到已有的手机账号下。
```
curl -X POST -d '{"wxnick":"abcdef","wxunionid":"uvwxyz","wxavatar":"https://hello.com/abc.jpg","phone":"15692138640","phonecode":"123456","password":"11111111","force":true}' $HOST/bind_wx_phone
```
这里force参数非必需，force为true时，强制加到已有的手机账号下。
## get_phonecode
获取短信验证码
```
curl -X POST -d '{"phone":"15692138640"}' $HOST/get_phonecode
```
## register_phone
手机号注册
```
curl -X POST -d '{"phone":"15692138640","phonecode":"177321","password":"11111111"}' $HOST/register_phone
```
## get_emailcode
获取邮箱验证码
```
curl -X POST -d '{"email":"huangguozheng@yijianar.com"}' $HOST/get_emailcode
```
## register_email
email注册
```
curl -X POST -d '{"email":"huangguozheng@yijianar.com","emailcode":"204998","password":"11111111"}' $HOST/register_email
```
## phonelogin
手机号登录
```
curl -X POST -d '{"phone":"15692138640","password":"11111111"}' $HOST/phonelogin
```
## phonecodelogin
手机号验证码登录
```
curl -X POST -d '{"phone":"15692138640","phonecode":"177321"}' $HOST/phonecodelogin
```
## emaillogin
email登录
```
curl -X POST -d '{"email":"huangguozheng@yijianar.com","password":"11111111"}' $HOST/emaillogin
```
## emailcodelogin
email验证码登录
```
curl -X POST -d '{"email":"huangguozheng@yijianar.com","emailcode":"204998"}' $HOST/emailcodelogin
```
## bind_phone
绑定手机号，针对非手机号注册账号
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":"271","phone":"15692138640","phonecode":"123456"}' $HOST/bind_phone
```
## bind_email
绑定邮箱，针对非邮箱注册账号
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":"271","email":"huangguozheng@yijianar.com","emailcode":"123456"}' $HOST/bind_email
```
## bind_wechat
绑定微信，针对非微信注册账号
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":"271","code":"001gFT0w34zkHZ2xtJ2w3ybNGn2gFT0f"}' $HOST/bind_wechat
```
## bind_dingtalk
绑定钉钉，针对非钉钉注册账号
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":"271","code":"rstuvwxyz"}' $HOST/bind_dingtalk
```
## unbind_wechat
解绑微信，针对非微信注册用户
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":"271"}' $HOST/unbind_wechat
```
## unbind_dingtalk
解绑钉钉，针对非钉钉注册用户
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":"271"}' $HOST/unbind_dingtalk
```
## check_phone_code
确认手机号，用于更换手机号
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"phone":"15692138659","phonecode":"123456"}' $HOST/check_phone_code
```
## change_phone
更换手机号
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"oldcode":"123456","oldphone":"15600001111","newcode":"654321","newphone":"15611110000"}' $HOST/change_phone
```
## check_email_code
确认邮箱，用于更换邮箱
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"email":"huangguozheng@yijianar.com","emailcode":"123456"}' $HOST/check_email_code
```
## change_email
更换邮箱
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"oldcode":"123456","oldemail":"huangguozheng@yijianar.com","newcode":"654321","newemail":"hamiltonhgz@gmail.com"}' $HOST/change_email
```
## reset_password
重置密码，针对手机号注册用户
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"phone":"15692138640","phonecode":"654321","password":"22222222"}' $HOST/reset_password
```
## reset_email_password
重置密码，针对邮箱注册用户
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"email":"huangguozheng@yijianar.com","emailcode":"654321","password":"22222222"}' $HOST/reset_email_password
```
------

## list_users
权限管理页的用户列表，query参数用于姓名、手机号、邮箱和公司的模糊搜索
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"query":"156","datefrom":"2022-01-01","dateto":"2022-12-01","is_dd_member":true,"department":"研发中心","is_time_asc":true,"page":2,"num_per_page":20}' $HOST/list_users
```
参数datefrom,dateto,page,num_per_page都非必需  
is_dd_number,department,is_time_asc非必需，没有参数表示搜全部
## edit_user
编辑用户信息
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"id":74,"name":"黄药师","company":"一见科技","department":"保卫地球部","groups":"一见科技;保卫地球"}' $HOST/edit_user
```
## sync_dd_dept
同步组织架构,对绑定了钉钉(有ddid)的用户进行遍历，更新公司和部门。如果ddid查不到了，表明用户已离职，擦除公司部门。
```
curl -X POST -H 'Authorization:Bearer TOKEN' $HOST/sync_dd_dept
```
## list_groups
分组列表，没有绑定钉钉的用户没有用户名，为了避免bug,这里用未命名暂替。
```
curl -X POST -H 'Authorization:Bearer TOKEN' $HOST/list_groups
```
## new_group
新建分组
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"name":"核酸组","permissions":"智能图像;传感互联"}' $HOST/new_group
```
## edit_group
编辑分组
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"id":100,"name":"核酸组","permissions":"智能图像;传感互联"}' $HOST/edit_group
```
## delete_group
删除分组
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"id":100}' $HOST/delete_group
```
## list_group_users
组内用户列表
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"id":100}' $HOST/list_group_users
```
## add_group_user
添加分组用户
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"id":100,"userids":[74,121,234]}' $HOST/add_group_user
```
## delete_group_user
删除分组用户
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"name":"保卫地球组","userid":74}' $HOST/delete_group_user
```
## refresh_permission
为了在管理员编辑用户权限后，用户能在不退出的情况下更新权限，页面要不断刷新权限
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"id":74}' $HOST/refresh_permission
```
------

## md_upload
md文档上传
```
curl -F markdown=@服务器维护.md -F author=黄国政 -F tags='["python","markdown","server"]' -F folder=核心文档/服务器 $HOST/md_upload
```
上传后，服务器保留md文档。  
返回的did字段为文档id。可以用did获取文档内容。
## md_update
md文档修改
```
curl -F markdown=@服务器维护.md -F author=黄国政 -F tags='["python","server"]' -F did='191785985'  $HOST/md_update
```
如果不需要改标签，则不要上传tags字段。
## md_content
查看文档内容和附加属性，用于查看和预览
```
curl -H 'Authorization:Bearer TOKEN' $HOST/md_content/014250443
```
## publish_file
发布文档
```
curl -H 'Authorization:Bearer TOKEN' $HOST/publish_file/014250443
```
## lsdir
文档目录列表
```
curl $HOST/lsdir
```
## mkdir
创建文件夹
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"folder":"核心文档/三维算法"}' $HOST/mkdir
```
## rmdir
删除文件夹
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"folder":"核心文档/三维算法"}' $HOST/rmdir
```
## rndir(和mvdir重复，删除)
重命名文件夹
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"root":"内部文档","folder":"三维算法","newname":"新文件夹名"}' $HOST/rndir
```
## mvdir
移动和重命名文件夹
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"folder":"核心文档/三维算法","destfolder":"内部文档/3D算法"}' $HOST/mvdir
```
## rmfile
删除文件
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"did":"014250443"}' $HOST/rmfile
```
## rnfile(和mvfile重复，删除)
重命名文件
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"root":"内部文档","folder":"测试dir","filename":"rnfile.html","newname":"newfile.html"}' $HOST/rnfile
```
## mvfile
移动或重命名文件
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"did":"014250443","destfile":"核心文档/服务器/开发者平台"}' $HOST/mvfile
```
## search_title_in_apifolder
按标题检索
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"title":"智能"}' $HOST/search_title_in_apifolder
```
## search_tag_in_apifolder
按标签检索
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"tag":"智能"}' $HOST/search_tag_in_apifolder
```
## search_content_in_apifolder
按内容检索
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"content":"智能"}' $HOST/search_content_in_apifolder
```
## search_all_in_apifolder
综合检索
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"all":"智能"}' $HOST/search_all_in_apifolder
```
------

## get_oss_signature
文件直传OSS所需的签名
```
curl -H 'Authorization:Bearer TOKEN' $HOST/get_oss_signature?userid=74
```
## uploadfile
OPENDATA里，文件直传oss后，还需填表单提交，这样文件列表能对应上
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":74,"filepath":"74/pics/ai.png","title":"","description":"","author":"","project":"","overview":"","coverpath":"","phase":"","type":"","ispublic":false}' $HOST/uploadfile
```
参数只有userid和filepath必需，其余非必需。
## list_files
文件列表
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"userid":74}' $HOST/list_files 
```
## get_download_url
生成文件的下载链接
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"fileid":100}' $HOST/get_download_url
```
------

## start_task
启动模型转换任务
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"filename":"abc.rvt","size":1234,"task":"RvtToOsBim","userid":"74","username":"虚竹","phone":"13600001111","compress":1,"markpr":1}' $HOST/start_task
```
filename,size为前端直传后的oss参数，必需，task为模型服里的任务名，必需，userid和phone必需。其余参数非必需  
如果前端没有用户phone信息，则用email信息填充phone字段
## query_tasks
查询任务进度
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"taskids":["1234","abcd"]}' $HOST/query_tasks
```
## cancel_task
取消任务
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"taskid":"abcd"}' $HOST/cancel_task
```
## restart_task
重启任务
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"taskid":"abcd"}' $HOST/restart_task
```
## download_url_model
为了让下载名和上传名保持一致，下载链接重新生成
```
curl -X POST -H 'Authorization:Bearer TOKEN' -d '{"downloadname":"上传文件名","filepath":"74/osbim/hello.zip"}' $HOST/download_url_model
```

---
## detection/image
图像检测
```
curl -X POST -d '{"filepath":"https://p2.itc.cn/images01/20210510/096eeb9cd3c84bd8ba09b5713679b4f9.jpeg","target":"edge"}' https://dev.yijianar.com:8444/detection/image
curl -X POST -d '{"filepath":"img/quanjing.jpg","target":"pano_pedestrian"}' https://dev.yijianar.com:8444/detection/image
``` 
filepath可以是网上的图片地址url(http开头)，文件直传OSS后的路径(如74/img/abc.jpg)  
target分edge,crack,rebar,mask,helmet,area,segmentation,pedestrian 和 pano_edge,pano_crack,pano_rebar,pano_mask,pano_helmet,pano_area,pano_segmentation,pano_pedestrian. 分别代表边缘、裂纹、钢筋、口罩、头盔、安全、分割、行人。pano表示全景。

## detection/video
视频检测
```
curl -X POST -d '{"filepath":"213/crack.mp4","target":"crack","ts":1234}' https://dev.yijianar.com:8444/detection/video
```

## detection/rtsp[未完成]
流的检测和上面接口类似，多了时间戳参数
```
curl -X POST -d '{"filepath":"rtsp://admin:Yijian@2018!@192.168.40.105:554/h264/ch1/main/av_stream","target":"edge","ts":"1670902401"}' https://dev.yijianar.com:8444/detection/rtsp
```

## hls/m3u8
播放器所需地址，可能需要等待
[https://dev.yijianar.com:8444/hls/1670902401_edge.m3u8](https://dev.yijianar.com:8444/hls/1670902401_edge.m3u8)
```
curl https://dev.yijianar.com:8444/hls/1670902401_edge.m3u8
curl https://dev.yijianar.com:8444/hls/1126.m3u8
```

## rtsp_pure
纯净流
```
curl -X POST -d '{"filepath":"rtsp://admin:Yijian@2018!@192.168.40.105:554/h264/ch1/main/av_stream","ts":"1126"}' https://dev.yijianar.com:8444/rtsp_pure
```

## rtsp_kill
杀掉rtsp子进程,pid为上步返回
```
curl https://dev.yijianar.com:8444/rtsp_kill/1412609
```
注：为了避免因一些意外情况，进程没杀掉。系统会在每晚强制杀死所有rtsp相关进程。

## ocr/cad_words
识别cad的png图片
```
curl -X POST -d '{"filepath":"img/testcad.png"}' https://dev.yijianar.com:8444/ocr/cad_words
```

## chatgpt
调用openai接口做AIGC(AI generative content)
```
curl -X POST -d '{"prompt":"写一个住房租赁合同"}' $HOST/chatgpt_completion
```
## gpt-3.5-turbo
```
curl -X POST -d '{"messages":[{"role":user,"content":"你好"}]}' https://dev.yijianar.com/gpt/chatgpt
```
messages参数为数组。 用户的问题，role是user。系统的回答，role是system。 

