# 查看硬件配置
```shell
lsb_release -a
cat /proc/cpuinfo
free -m
df -h
```

# GPU服务器
## 硬件配置
部件 | 配置
--- | ---
CPU | AMD Ryzen 7 5800X 8-Core Processor
内存 | 32G
SSD硬盘 | 500G
HDD硬盘 | 2T
GPU | NVIDIA GeForce RTX 3090 (专用内存24G)
OS | Ubuntu Desktop 22.04

## 账号
### yjserver@yjserver
用户名 | 密码
--- | ---
yjserver | yijiankeji
beginner | yj123456
zhang | yj123456
### aiserver@aiserver
用户名 | 密码
--- | ---
aiserver | yijiankeji

## 安装nvidia驱动
```shell
ubuntu-drivers devices
sudo ubuntu-drivers autoinstall
sudo reboot
nvidia-smi
```

## 安装深度学习环境
安装CUDA和cuDNN,检查在GPU上运行的TensorFlow和PyTorch.  
[https://medium.com/@serdar.akyol/set-up-gaming-laptops-for-pytorch-and-tensorflow-work-on-gpu-on-ubuntu-21-10-or-22-04-6f9b4bbb335b](https://medium.com/@serdar.akyol/set-up-gaming-laptops-for-pytorch-and-tensorflow-work-on-gpu-on-ubuntu-21-10-or-22-04-6f9b4bbb335b)
CUDA 11.2 最大只支持gcc 9, 但我们Ubuntu 22.04上却是gcc 11.2. 所以先安装gcc-9.

## 显卡问题处理
2022-09-03 yjserver 显卡因驱动升级而崩溃
```shell
dpkg -l | grep nvidia
    linux-modules-nvidia-510-5.15.0-35-generic
    linux-objects-nvidia-510-5.15.0-35-generic
    linux-signatures-nvidia-5.15.0-46-generic
    nvidia-compute-utils-510  510.85.02-0ubuntu0.22.04.1
    nvidia-dkms-510  510.85.02-0ubuntu0.22.04.1
```
```
lspci | grep -e VGA     # 我们的显卡是 nvidia GeForce RTX 3090
wget https://us.download.nvidia.com/XFree86/Linux-x86_64/515.65.01/NVIDIA-Linux-x86_64-515.65.01.run    # 在https://www.nvidia.com/Download/index.aspx?lang=en-us 上找到driver
```
2022-09-06 aiserver 也因显卡驱动问题起不来图形界面。  
[https://www.if-not-true-then-false.com/2021/debian-ubuntu-linux-mint-nvidia-guide/](https://www.if-not-true-then-false.com/2021/debian-ubuntu-linux-mint-nvidia-guide/)
看这个guide解决。 特别要注意510 和 515的冲突。我们升级到515，所以把510的安装包全删了
```shell
sudo apt purge *nvidia*510*
```
2022-09-26 aiserver再次因断电重启而导致nvidia driver fail. nvidia-smi has failed because it couldn't communicate with the NVIDIA driver.  
再次运行 NVIDIA 515 run
```shell
sudo -i
NVIDIA-Linux-x86_64-515.65.01.run
```
2022-11-08 yjserver因机房整理，断电导致nvidia driver fail.发现官方驱动已更新到5.20  
卸光之前的driver, reboot
```shell
./NVIDIA-Linux-x86_64-520.56.06.run
```
如果无法安装，先
```shell
sudo apt install nvidia-utils-520
```
2022-11-22 aiserver经常退出登录，预计是显卡问题。故重新安装520Driver,但提示
```shell
# Failed to initialize NVML: Driver/library version mismatch
dpkg -l | grep nvidia 
cat /proc/driver/nvidia/version
cat /sys/module/nvidia/version
```
```shell
sudo apt purge $(dpkg -l | grep nvidia-driver | awk '{print $2}')
sudo apt autoremove
ubuntu-drivers devices  # 找到recommend
```
2022-12-05 aiserver/yjserver 同时出现 Failed to initialize NVML: Driver/library version mismatch
最新版本是525且没了520,如何能让 /proc/driver/nvidia/version升到525呢？  
~~ 下雨天网络不稳定。导致apt update不成功。 Failed to fetch https://ppa.launchpadcontent.net/ ~~  
```shell
sudo apt purge *nvidia*
sudo apt autoremove
sudo apt install nvidia-utils-525
sudo apt install nvidia-driver-525
sudo reboot
```
这样 cat /proc/driver/nvidia/version 就更新到525. yjserver好像也不再需要安装离线下载的安装包了。  
对于aiserver,怎么重启都没用，没法让sys driver从520升到525. 最后通过先禁掉图形界面，再启动图形界面的方式来解决
```shell
sudo systemctl set-default multi-user.target
sudo reboot
sudo ./NVIDIA*.run
sudo systemctl set-default graphical.target
```
2022-12-16 aiserver重启后再次崩溃,原来从525.53升级到525.60. 下载。 按照文档仔细走了一遍才解决。



## proxychains改出口IP
安装pyTorch等库时，可能会被墙，需要改变ip出口地址
```shell
wget https://github.com/trojan-gfw/trojan/releases/download/v1.16.0/trojan-1.16.0-linux-amd64.tar.xz
tar xvf && cd
vim config.json
./trojan
```
```shell
sudo apt install proxychains-ng, curl
vim /etc/proxychains4.conf
    socks5 127.0.0.1 1080
```
```shell
curl -4 ip.sb   # 116.235.140.169(公司出口ip)
proxychains4 curl -4 ip.sb    # 107.182.187.83(美国出口ip)
```
自此之后，为了规避安装库时被墙，只需在命令前加proxychains4
```shell
proxychains4 pip install torch torchvision
```

## frp内网穿透
为了随时随地能访问跑算法模型,需要内网穿透.  
跳板机(外网):
```shell
wget https://github.com/fatedier/frp/releases/download/v0.43.0/frp_0.43.0_linux_amd64.tar.gz
tar xzvf & cd
vim frps.ini
    [common]
    bind_port = 7006
nohup ./frps -c frps.ini > ~/logs/frps.log &
```
内网机(内网):
```shell
wget https://github.com/fatedier/frp/releases/download/v0.43.0/frp_0.43.0_linux_amd64.tar.gz
tar xzvf & cd
vim frpc.ini
    [common]
    server_addr = developer.yijianar.com
    server_port = 7006
    [ssh]
    type = tcp
    local_ip = 127.0.0.1
    local_port = 22
    remote_port = 8023
./frpc -c frpc.ini
```
这样任何地方都能通过 ssh username@developer.yijianar.com -p 8023 访问内网机了。

# Git服务器
## Gitlab搭建
略

## 自动备份
ubuntu中，gitlab仓库在/var/opt/gitlab/git-data/repositories中, gitlab的备份文件保存在/var/opt/gitlab/backups中
sudo vim /etc/gitlab/gitlab.rb
```shell
#gitlab_rails['manage_backup_path'] = ture
#gitlab_rails['backup_path'] = "/var/opt/gitlab/backups"
...
#gitlab_rails['backup_keep_time'] = 604800
```
```shell
sudo gitlab-ctl reconfig
gitlab-rake gitlab:backup:create
```

## puma设置
```shell
puma['worker_processes'] = 2
puma['min_threads'] = 4
puma['max_threads'] = 4
nginx['worker_processes'] = 2
```
```shell
sudo gitlab-ctl reconfig
sudo gitlab-ctl restart
```

## 问题排查
首先定位 /etc/gitlab/gitlab.rb
```shell
sudo gitlab-ctl status
sudo gitlab-ctl restart
```
### 查看端口
```shell
sudo lsof -i -P -n | grep LISTEN
sudo netstat -tulpn
```
### 查看磁盘空间
```shell
df -h
du -lh (--max-depth=1)
```
2022-06-17 查出的问题是 /var/lib/docker空间占了194G  
最后，加了大容量机械盘解决  
```shell
Filesystem                         Size  Used Avail Use% Mounted on
/dev/mapper/ubuntu--vg-ubuntu--lv  233G   38G  183G  18% /
/dev/nvme0n1p1                     220G   28K  208G   1% /home/yijian/data/dc
/dev/sda                           1.8T  397G  1.4T  23% /home/yijian/data/docker
```
### 查某一进程
```shell
sudo gitlab-ctl tail postgresql
```
## 硬盘操作
```shell
sudo blkid
sudo fdisk -l
```
### partition
```shell
sudo parted /dev/sda
mklabel gpt
mkpart primary 0GB 1.82TB
quit
```
> You may need to update /etc/fstab

```shell
sudo mkfs.ext4 /dev/sda
df -h
```
### mount
```shell
sudo mkdir /mnt/sda
sudo mount /dev/sda /mnt/sda
```
> Temporarily mount, whenever restart system, must mount again.
### permanently mount
```shell
sudo vim /etc/fstab
/dev/sda  /mnt/sda  ext4  defaults  0 0
```
### check drive mounted
```shell
sudo mount | grep sda
df -h
```

# WEB服务器
## 登录服务器
```shell
ssh -i ~/.ssh/开发者平台.pem ecs-user@47.102.145.41
ssh -i ~/.ssh/开发者平台测试.pem root@122.9.140.8
```
最好在.zshrc 或 .bashrc中编辑
```shell
alias sshdev='ssh -i ~/.ssh/开发者平台.pem ecs-user@47.102.145.41'
```
这样以后可以用sshdev一键登录. 为了避免root账号操作带来的危险，我们 su dev
## 修改apt源
阿里云、华为云等国内云的apt源通常是云服务商自己的。有时更新或安装时会有问题。 最好改回国际源。
```shell
sudo vim /etc/apt/sources.list
:%s/repo.huaweicloud.com/archive.ubuntu.com
sudo apt update
```
## 安装配置nginx
```shell
sudo apt install nginx
sudo scp -r root@developer.yijianar.com:/etc/nginx/cert /etc/nginx/
sudo vim /etc/nginx/sites-available/beta-dev.yijianar.com
```
```json
server {
    listen 80;
    listen [::]:80;

    server_name beta-dev.yijianar.com;

    root /home/dev/projects/developersite/dist/;
    index index.html;

    location / {
        try_files $uri $uri/ @router;
        index index.html;
    }
    location @router {
        rewrite ^.*$ /index.html last;
    }

    location /api/ {
        proxy_pass http://localhost:8008/;
    }

    listen 443 ssl;
    ssl_certificate cert/developer.yijianar.com.pem;
    ssl_certificate_key cert/developer.yijianar.com.key;
}
```
```shell
cd ../sites-enabled/
sudo ln -s /etc/nginx/sites-available/beta-dev.yijianar.com beta-dev.yijianar.com
sudo systemctl restart nginx
```
## 安装 mysql
```shell
sudo apt install mysql-server
sudo mysql
> CREATE USER 'hamilton'@'%' IDENTIFIED BY 'poiu0987';
> CREATE USER 'username'@'%' IDENTIFIED WITH mysql_native_password BY 'password';
> GRANT ALL PRIVILEGES ON *.* TO 'hamilton'@'%';
> FLUSH PRIVILEGES;
```
此时服务器本地可以通过 mysql -u yijian -p 来登录mysql。测试服务器我们希望数据库能远程访问，便于校对数据。
```shell
sudo edit /etc/mysql/mysql.conf.d/mysqld.cnf 
    bind-address 0.0.0.0
sudo systemctl restart mysql
```
## 安装 redis
```
sudo apt install redis-server
```

# RTK服务器
2022.09.05服务器挂了。且重启后仍无法访问。据猜测是带宽占满。做了服务器迁移。
## 安装frps
```shell
wget https://github.com/fatedier/frp/releases/download/v0.44.0/frp_0.44.0_linux_amd64.tar.gz
tar xzvf frp_0.44.0_linux_amd64.tar.gz
cd 
sudo cp frps /usr/bin/
sudo mkdir /etc/frp
sudo cp frps.ini /etc/frp/
sudo mkdir /var/frp
sudo vim /etc/systemd/system/frps.service
    [Unit]
    Description=frps
    Documentation=https://github.com/fatedier/frp
    After=network-online.target
    [Service]
    ExecStart=/usr/bin/frps -c /etc/frp/frps.ini
    Type=simple
    User=nobody
    Group=nogroup
    WorkingDirectory=/tmp
    Restart=on-failure
    RestartSec=60s
    [Install]
    WantedBy=multi-user.target
```

