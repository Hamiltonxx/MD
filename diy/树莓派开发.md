# Say Hello
Rasyberry Pi是英国制造的信用卡大小的计算机，处理器用的ARM，和手机一样。操作系统是Raspberry Pi OS. 没有硬件驱动，系统安装在SD卡上。 可以通过HDMI连接显示器，可以通过USB连接键盘鼠标，用USB C连接电源。有网口，可以用网线连网。Raspberry Pi 4有无线网络和蓝牙。

# MAC写Raspbian OS到SD卡
Raspberry Pi用的microsd卡，我们用 SD/TF -> USB C转接头，插入MAC PC.  
打开Terminal
```shell
diskutil list
diskutil unmountDisk /dev/disk2
sudo dd if=2022-04-04-raspios-bullseye-arm64-lite.img of=/dev/rdisk2
# 3907584+0 records in
# 3907584+0 records out
# 2000683008 bytes transferred in 998.193064 secs (2004305 bytes/sec)
diskutil eject /dev/rdisk2
```
注意： 64G以上的SD卡，可能默认是exFAT格式。需要先重新格式化成FAT32.  
FAT16的容量范围:128M~2G; FAT32的容量范围:4G~32G; exFAT的容量范围64G~2T.
```
diskutil eraseDisk FAT32 RASPBIAN MBRFormat /dev/disk2
```

# 开机初始化
如果要使用ROS/Ubuntu系统。请直接跳到 更换为Ubuntu系统章节。  
第一次开启系统，会让你输入用户名和密码。  
笔者用Type C充电，HDMI转接显示器。 由于我们后面一般都SSH远程登录，此处不必在意屏幕分辨率。  
插上网口， ifconfig显示ip 192.168.50.72.  
```shell
sudo raspi-config
System Options -> Wireless LAN -> SSID & Passphrase
Interface Options -> SSH -> enable
```
此时现实wlan0 IP为 192.168.50.74,然后就可以远程登录
```shell
ssh yjpi@192.168.50.74
```
此后，raspberry pi就可以只连电源玩了。  
```shell
alias ll='ls -la'
```

# 软件安装
```
sudo apt install python3-pip
sudo apt install git
```
## 安装图形界面
为了应付偶尔会用到的图形/桌面，我们安装XFCE(不是默认的PIXEL)  
```shell
sudo apt update && sudo apt upgrade && sudo apt dist-upgrade && sudo reboot
sudo apt install xserver-xorg -y
sudo apt install xfce4 xfce4-terminal -y
sudo apt install lightdm
```
此后就能用 sudo systemctl start lightdm来开启桌面了。
## 桌面定制
### lightdm autologin
```shell
sudo vim /etc/lightdm/lightdm.conf
  autologin-guest=false
  autologin-user=damien
  autologin-user-timeout=0
```

# 更换为Ubuntu系统
为了安装ros2, 我们需要Ubuntu Server 22.04 for Raspberry Pi  
```shell
diskutil list
diskutil unmountDisk /dev/disk2
sudo dd if=ubuntu-22.04-preinstalled-server-arm64+raspi.img of=/dev/rdisk2
```
由于ubuntu-22.04-xxx.img有3个多G,dd命令可能会持续一小时以后以上。为了节省时间，先用[PiShrink image](https://github.com/Drewsif/PiShrink) 再dd. 提示parted not installed. 放弃  
采用 [balenaEtcher](https://www.balena.io/etcher/)
刷完卡，插入raspberry pi,启动后，有个默认账户 ubuntu/ubuntu. 需要改密码123456  
## 连wifi
```shell
ls /sys/class/net
ls /etc/netplan/
sudo vim /etc/netplan/50-cloud-init.yaml
# 在紧跟 version: 2行之后
wifis:
    wlan0:
        dhcp4: true
        optional: true
        access-points:
          "Onesight_5G":
            password: 'yijiankeji'
sudo netplan apply
ping www.baidu.com
ifconfig
```
## 安装 lubuntu
```shell
sudo apt update
sudo apt full-upgrade
sudo apt install lubuntu-desktop
```
重启后没有出现login screen. 此时需要 Ctrl+Alt+F2 来login
```shell
sudo apt install lightdm
sudo reboot
```

# 安装 ROS 2
```shell
sudo apt install trojan proxychains-ng
trojan -c trojan.config
```
```shell
locale  # check for UTF-8

sudo apt update && sudo apt install locales
sudo locale-gen en_US en_US.UTF-8
sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
export LANG=en_US.UTF-8

locale  # verify settings

apt-cache policy | grep universe

sudo apt update && sudo apt install curl gnupg lsb-release
proxychains4 sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(source /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null

sudo apt update
sudo apt upgrade

sudo apt install ros-humble-desktop
```

# Try example
```shell
source /opt/ros/humble/setup.bash
ros2 run demo_nodes_cpp talker
```
```shell
source /opt/ros/humble/setup.bash
ros2 run demo_nodes_py listener
```

# 开机自启
有一些进程/程序，我们希望在Raspberry Pi开机后就自动启动。这里给一个systemd模板。  
```shell
sudo vim /etc/systemd/system/xxx.service
  [Unit]
  Description=Start RTK
  After=network-online.target
  Wants=network-online.target
  [Service]
  User=yijian
  Group=yijian
  ExecStart=/bin/bash -c "cd /home/yijian/dev/project; python main.py >> /home/yijian/logs/rtk.log"
  [Install]
  WantedBy=multi-user.target

sudo systemctl daemon-reload
sudo systemctl enable rtk.service
sudo systemctl start rtk.service
sudo reboot
```
## Trojan
```shell
sudo apt install trojan
```
config文件见《Trojan科学上网》，覆盖 /etc/trojan/config.json.
```
sudo systemctl start trojan
sudo systemctl enable trojan
```
## Frp

# GPS模块
我们上淘宝买了廉价的GPS/GNSS模块，[淘宝链接](https://item.taobao.com/item.htm?spm=a1z09.2.0.0.135a2e8d3yHYqG&id=642893444780&_u=alcfidl1512)
接上RX,TX,GND,VCC四个引脚后，通过 
```shell
sudo dmesg | grep tty
```
可以看到串口ttyS0被enable,且base_baud=62500000  
如果是ubuntu mate,需要手动enable
```
sudo vim /boot/firmware/config.txt
  enable_uart=1
sudo reboot
```
```shell
sudo cat /dev/ttyS0
```
可以看到$GPGSA, $GNGGA, $GNRMC等数据
## minicom调试
```shell
sudo apt install minicom
sudo minicom -D /dev/ttyS0 -b 9600
```
-D 代表端口。 设置波特率为9600. 结果在Terminal上显示格式很乱。
## python程序
```shell
git clone https://github.com/waveshare/L76X-GPS-Module.git
```
可以看出代码依赖RPi.GPIO 和 pyserial两个库
```shell
sudo pip3 install RPi.GPIO
sudo pip3 install pyserial
```
注意这里用sudo安装。因为程序里会读串口数据，需要用sudo python3来运行。另外代码版本是python 2.x,把里面的print xxx改成print(xxx)就可以转为python3版本。  

## 现场测试
办公室Lng和Lat一直为0，应该是没有信号导致。得去室外。  
室外测试，一般情况需要带的东西很多，除了树莓派及扩展，还得带上显示器、键盘、鼠标、数据线、充电宝等等。举家迁移实在麻烦。  
我们这里让树莓派连手机热点，用mac ssh连接和控制树莓派然后运行程序。这样我们只需带树莓派及扩展，充电宝，数据线，手机和Laptop(Macbook Pro)
```shell
sudo iwlist wlan0 scan | grep ESSID  
```
找到我们的手机热点Hiphone,(默认的ssid有点长，我们改短一点).  
```shell
sudo vim /etc/wpa_supplicant/wpa_supplicant.conf
  network={
    ssid="Hiphone"
    psk="xxxxxxxx"
  }
sudo reboot
ifconfig
```
能看到wlan0的ip地址是172.20.10.6,已连上网。  
此时把Laptop也连上热点Hiphone. ifconfig的结果是 172.20.10.5. 很好，已经在同一个局域网里了。
```shell
ssh rpi@172.20.10.6
```
SSH登录，调试代码。